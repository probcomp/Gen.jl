<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Modeling Language Implementation · Gen</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link href="../../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>Gen</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../../">Home</a></li><li><a class="toctext" href="../../../getting_started/">Getting Started</a></li><li><a class="toctext" href="../../../tutorials/">Tutorials</a></li><li><span class="toctext">Modeling Languages and APIs</span><ul><li><a class="toctext" href="../../gfi/">Generative Functions</a></li><li><a class="toctext" href="../../distributions/">Probability Distributions</a></li><li><a class="toctext" href="../../modeling/">Built-in Modeling Language</a></li><li><a class="toctext" href="../../combinators/">Generative Function Combinators</a></li><li><a class="toctext" href="../../choice_maps/">Choice Maps</a></li><li><a class="toctext" href="../../selections/">Selections</a></li><li><a class="toctext" href="../../parameter_optimization/">Optimizing Trainable Parameters</a></li><li><a class="toctext" href="../../trace_translators/">Trace Translators</a></li><li><a class="toctext" href="../../extending/">Extending Gen</a></li></ul></li><li><span class="toctext">Standard Inference Library</span><ul><li><a class="toctext" href="../../importance/">Importance Sampling</a></li><li><a class="toctext" href="../../map/">MAP Optimization</a></li><li><a class="toctext" href="../../mcmc/">Markov chain Monte Carlo</a></li><li><a class="toctext" href="../../map/">MAP Optimization</a></li><li><a class="toctext" href="../../pf/">Particle Filtering</a></li><li><a class="toctext" href="../../vi/">Variational Inference</a></li><li><a class="toctext" href="../../learning/">Learning Generative Functions</a></li></ul></li><li><span class="toctext">Internals</span><ul><li><a class="toctext" href="../parameter_optimization/">Optimizing Trainable Parameters</a></li><li class="current"><a class="toctext" href>Modeling Language Implementation</a><ul class="internal"><li><a class="toctext" href="#Parsing-@gen-functions-1">Parsing <code>@gen</code> functions</a></li></ul></li></ul></li></ul></nav><article id="docs"><header><nav><ul><li>Internals</li><li><a href>Modeling Language Implementation</a></li></ul><a class="edit-page" href="https://github.com/probcomp/Gen.jl/blob/master/docs/src/ref/internals/language_implementation.md"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>Modeling Language Implementation</span><a class="fa fa-bars" href="#"></a></div></header><h1><a class="nav-anchor" id="language-implementation-1" href="#language-implementation-1">Modeling Language Implementation</a></h1><h2><a class="nav-anchor" id="Parsing-@gen-functions-1" href="#Parsing-@gen-functions-1">Parsing <code>@gen</code> functions</a></h2><p>Gen&#39;s built-in modeling languages are designed to preserve Julia&#39;s syntax as far as possible, apart from the <a href="../../modeling/#Tilde-syntax-1">Tilde syntax</a> for calling generative functions, and the restrictions imposed on the <a href="../../modeling/#Static-Modeling-Language-1">Static Modeling Language</a>. In order to preserve that syntax, including the use of non-Gen macros within <code>@gen</code> functions, we relegate as much of the parsing of <code>@gen</code> functions as possible to Julia&#39;s macro-expander and parser.</p><p>In particular, we adopt an implementation strategy that enforces a separation between the surface syntax associated with Gen-specific macros (i.e., <code>@trace</code> and <code>@param</code>) and their corresponding implementations, which differ across the Dynamic Modeling Language (DML) and the Static Modeling Language (SML). We do this by introducing the custom expressions <code>Expr(:gentrace, call, addr)</code> and <code>Expr(:genparam, name, type)</code>, which serve as intermediate representations in the macro-expanded <a href="https://docs.julialang.org/en/v1/manual/metaprogramming/#Program-representation-1">abstract syntax tree</a>.</p><p>Each modeling language can then handle these custom expressions in their own manner, either by parsing them to nodes in the <a href="ref/internals/@ref">Static Computation Graph</a> (for the SML), or by substituting them with their implementations (for the DML). This effectively allows the SML and DML to have separate implementations of <code>@trace</code> and <code>@param</code>.</p><p>For clarity, below is a procedural description of how the <code>@gen</code> macro processes Julia function syntax:</p><ol><li><code>macroexpand</code> the entire function body with respect to the calling module. This expands any (properly-scoped) <code>@trace</code> calls to <code>Expr(:gentrace, ...)</code> expressions, and any (properly-scoped) <code>@param</code> calls to <code>Expr(:genparam, ...)</code> expressions, while also expanding non-Gen macros.</li><li>Desugar any tilde expressions <code>x ~ gen_fn()</code>, including those that may have been generated by macros, to <code>Expr(:gentrace, ...)</code> expressions.</li><li>Pass the macro-expanded and de-sugared function body on to <code>make_static_gen_function</code> or <code>make_dynamic_gen_function</code> accordingly.</li><li>For static <code>@gen</code> functions, match <code>:gentrace</code> expressions when adding address nodes to the static computation graph, and match <code>:genparam</code> expressions when adding parameter nodes to the static computation graph. A <code>StaticIRGenerativeFunction</code> is then compiled from the static computation graph.</li><li>For dynamic <code>@gen</code> functions, rewrite any <code>:gentrace</code> expression with its implementation <code>dynamic_trace_impl</code>, and rewrite any <code>:genparam</code> expression with its implementation <code>dynamic_param_impl</code>. The rewritten syntax tree is then evaluated as a standard Julia function, which serves as the implementation of the constructed <code>DynamicDSLFunction</code>.</li></ol><footer><hr/><a class="previous" href="../parameter_optimization/"><span class="direction">Previous</span><span class="title">Optimizing Trainable Parameters</span></a></footer></article></body></html>
